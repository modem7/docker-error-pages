name: release

on:
  workflow_dispatch:

jobs:
  build:
    name: Build for ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        os: [linux, darwin] # linux, freebsd, darwin, windows
        arch: [amd64]  # amd64, 386
    steps:
      - uses: actions/setup-go@v2
        with: {go-version: 1.17.2}

      - uses: actions/checkout@v2

      - uses: gacts/github-slug@v1
        id: slug

      - name: Generate builder values
        id: values
        run: echo "::set-output name=binary-name::error-pages-${{ matrix.os }}-${{ matrix.arch }}"

      - name: Build application
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 0
          LDFLAGS: -s -w -X github.com/tarampampam/error-pages/internal/version.version=${{ steps.slug.outputs.version }}
        run: go build -trimpath -ldflags "$LDFLAGS" -o "./${{ steps.values.outputs.binary-name }}" ./cmd/error-pages/

      - name: Upload binary file to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ steps.values.outputs.binary-name }}
          asset_name: ${{ steps.values.outputs.binary-name }}
          tag: ${{ github.ref }}

  demo:
    name: Update the demonstration
    runs-on: ubuntu-20.04
    steps:
      - uses: gacts/github-slug@v1
        id: slug

      - name: Take rendered templates from the built docker image
        run: |
          docker create --name img modem7/error-page-test:latest
          docker cp img:/opt/html ./out
          docker rm -f img

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
